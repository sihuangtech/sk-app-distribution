# IP地理信息显示功能

## 功能概述

本功能为下载统计系统添加了IP地理信息显示能力，可以在下载历史记录中显示下载者的地理位置信息，包括国家、地区、城市和ISP等信息。

## 配置说明

### 1. 配置文件设置

在 `config.yaml` 文件中添加以下配置：

```yaml
geolocation:
  enabled: false                # 是否启用地理信息显示
  api_provider: ipapi           # API提供商：ipapi, ipstack, ipgeolocation
  api_key: ""                   # API密钥（ipapi免费服务无需密钥）
  cache_duration: 86400         # 缓存时间（秒），默认24小时
```

### 2. 支持的API提供商

#### IP-API (推荐)
- **免费服务**：无需注册和API密钥
- **限制**：每分钟1000次请求
- **配置**：`api_provider: ipapi`，`api_key` 留空

#### IPStack
- **需要注册**：https://ipstack.com/
- **免费额度**：每月10,000次请求
- **配置**：`api_provider: ipstack`，需要设置 `api_key`

#### IPGeolocation
- **需要注册**：https://ipgeolocation.io/
- **免费额度**：每月1,000次请求
- **配置**：`api_provider: ipgeolocation`，需要设置 `api_key`

#### IP2Location
- **需要注册**：https://www.ip2location.io/
- **免费额度**：每月30,000次请求
- **配置**：`api_provider: ip2location`，需要设置 `api_key`

### 3. 管理界面设置

1. 登录管理后台
2. 进入"系统设置"页面
3. 找到"地理信息配置"部分
4. 启用地理信息显示
5. 选择API提供商
6. 如需要，输入API密钥
7. 设置缓存时间（建议24小时）
8. 保存配置

## 功能特性

### 1. 智能缓存
- 自动缓存查询结果，减少API调用
- 可配置缓存时间（1-168小时）
- 自动清理过期缓存

### 2. 批量查询
- 支持批量查询历史记录的地理信息
- 限制并发请求数量，避免API限制
- 自动重试机制

### 3. 本地IP过滤
- 自动跳过本地IP地址（127.x.x.x, 192.168.x.x, 10.x.x.x等）
- 避免无效的API调用

### 4. 错误处理
- API调用失败时不影响下载记录功能
- 详细的错误日志记录
- 优雅降级，显示"未知"位置

## 显示信息

在下载历史记录中，地理信息列将显示：

- **主要位置**：城市, 地区, 国家
- **ISP信息**：互联网服务提供商（如果可用）
- **未知位置**：当无法获取地理信息时显示

## 数据存储

### 1. 缓存文件
- 位置：`data/location-cache.json`
- 格式：JSON
- 内容：IP地址到地理信息的映射

### 2. 下载历史
- 位置：`data/download-history.json`
- 新增字段：`location` 对象
- 包含：country, region, city, countryCode, regionCode, timezone, isp

## 性能优化

### 1. 缓存策略
- 默认缓存24小时
- 可根据需要调整缓存时间
- 自动清理过期数据

### 2. API限制处理
- 批量查询时限制并发数量
- 请求间隔控制
- 失败重试机制

### 3. 异步处理
- 地理信息查询不阻塞下载记录
- 后台异步更新位置信息

## 隐私说明

1. **IP地址处理**：仅用于地理信息查询，不存储敏感信息
2. **第三方API**：查询请求会发送到选择的API提供商
3. **数据缓存**：地理信息在本地缓存，减少外部请求
4. **可选功能**：可随时在设置中禁用此功能

## 故障排除

### 1. 地理信息不显示
- 检查配置是否启用
- 验证API密钥是否正确
- 查看服务器日志中的错误信息

### 2. API调用失败
- 检查网络连接
- 验证API密钥有效性
- 确认API额度是否用完

### 3. 缓存问题
- 删除 `data/location-cache.json` 文件重新开始
- 调整缓存时间设置
- 检查磁盘空间

## 更新日志

- **v1.1.0**: 初始版本，支持IP-API、IPStack、IPGeolocation、IP2Location四个提供商
- 支持智能缓存和批量查询
- 集成到管理界面设置页面 